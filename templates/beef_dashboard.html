{% extends "admin/base.html" %}

{% block title %}BeEF Dashboard - ZaloPay Portal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-bug"></i>
                        BeEF (Browser Exploitation Framework) Dashboard
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-success btn-sm" id="startBeefBtn">
                            <i class="fas fa-play"></i> Start BeEF Server
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" id="stopBeefBtn">
                            <i class="fas fa-stop"></i> Stop BeEF Server
                        </button>
                        <button type="button" class="btn btn-info btn-sm" id="refreshStatusBtn">
                            <i class="fas fa-sync"></i> Refresh Status
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- BeEF Status -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="info-box">
                                <span class="info-box-icon bg-info">
                                    <i class="fas fa-server"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">BeEF Server Status</span>
                                    <span class="info-box-number" id="beefStatus">
                                        {% if beef_running %}
                                            <span class="badge badge-success">Running</span>
                                        {% else %}
                                            <span class="badge badge-danger">Stopped</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning">
                                    <i class="fas fa-crosshairs"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Hooked Browsers</span>
                                    <span class="info-box-number" id="hookedBrowsers">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BeEF Modules -->
                    <div class="row">
                        <div class="col-12">
                            <h4>BeEF Modules (20 tính năng mạnh mẽ nhất)</h4>
                            
                            <!-- Information Gathering -->
                            <div class="card card-outline card-primary">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-search"></i>
                                        Information Gathering (5 modules)
                                    </h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for module_id, module in modules.items() %}
                                            {% if module.category == 'Information Gathering' %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card card-widget widget-user-2">
                                                    <div class="widget-user-header bg-gradient-primary">
                                                        <h5 class="widget-user-username">{{ module.name }}</h5>
                                                        <h6 class="widget-user-desc">{{ module.category }}</h6>
                                                    </div>
                                                    <div class="card-footer p-0">
                                                        <div class="p-3">
                                                            <p class="text-sm">{{ module.description }}</p>
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-success execute-module" 
                                                                        data-module-id="{{ module_id }}" 
                                                                        data-module-name="{{ module.name }}"
                                                                        {% if not module.enabled %}disabled{% endif %}>
                                                                    <i class="fas fa-play"></i> Execute
                                                                </button>
                                                                <button type="button" class="btn btn-secondary toggle-module" 
                                                                        data-module-id="{{ module_id }}">
                                                                    {% if module.enabled %}
                                                                        <i class="fas fa-toggle-on"></i> Enabled
                                                                    {% else %}
                                                                        <i class="fas fa-toggle-off"></i> Disabled
                                                                    {% endif %}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Client-Side Exploitation -->
                            <div class="card card-outline card-warning">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-code"></i>
                                        Client-Side Exploitation & Interaction (7 modules)
                                    </h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for module_id, module in modules.items() %}
                                            {% if module.category == 'Client-Side Exploitation' %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card card-widget widget-user-2">
                                                    <div class="widget-user-header bg-gradient-warning">
                                                        <h5 class="widget-user-username">{{ module.name }}</h5>
                                                        <h6 class="widget-user-desc">{{ module.category }}</h6>
                                                    </div>
                                                    <div class="card-footer p-0">
                                                        <div class="p-3">
                                                            <p class="text-sm">{{ module.description }}</p>
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-success execute-module" 
                                                                        data-module-id="{{ module_id }}" 
                                                                        data-module-name="{{ module.name }}"
                                                                        {% if not module.enabled %}disabled{% endif %}>
                                                                    <i class="fas fa-play"></i> Execute
                                                                </button>
                                                                <button type="button" class="btn btn-secondary toggle-module" 
                                                                        data-module-id="{{ module_id }}">
                                                                    {% if module.enabled %}
                                                                        <i class="fas fa-toggle-on"></i> Enabled
                                                                    {% else %}
                                                                        <i class="fas fa-toggle-off"></i> Disabled
                                                                    {% endif %}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Social Engineering -->
                            <div class="card card-outline card-danger">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-user-secret"></i>
                                        Social Engineering (5 modules)
                                    </h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for module_id, module in modules.items() %}
                                            {% if module.category == 'Social Engineering' %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card card-widget widget-user-2">
                                                    <div class="widget-user-header bg-gradient-danger">
                                                        <h5 class="widget-user-username">{{ module.name }}</h5>
                                                        <h6 class="widget-user-desc">{{ module.category }}</h6>
                                                    </div>
                                                    <div class="card-footer p-0">
                                                        <div class="p-3">
                                                            <p class="text-sm">{{ module.description }}</p>
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-success execute-module" 
                                                                        data-module-id="{{ module_id }}" 
                                                                        data-module-name="{{ module.name }}"
                                                                        {% if not module.enabled %}disabled{% endif %}>
                                                                    <i class="fas fa-play"></i> Execute
                                                                </button>
                                                                <button type="button" class="btn btn-secondary toggle-module" 
                                                                        data-module-id="{{ module_id }}">
                                                                    {% if module.enabled %}
                                                                        <i class="fas fa-toggle-on"></i> Enabled
                                                                    {% else %}
                                                                        <i class="fas fa-toggle-off"></i> Disabled
                                                                    {% endif %}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Persistence & Advanced -->
                            <div class="card card-outline card-dark">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-shield-alt"></i>
                                        Persistence & Advanced (3 modules)
                                    </h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for module_id, module in modules.items() %}
                                            {% if module.category == 'Persistence & Advanced' %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card card-widget widget-user-2">
                                                    <div class="widget-user-header bg-gradient-dark">
                                                        <h5 class="widget-user-username">{{ module.name }}</h5>
                                                        <h6 class="widget-user-desc">{{ module.category }}</h6>
                                    </div>
                                                    <div class="card-footer p-0">
                                                        <div class="p-3">
                                                            <p class="text-sm">{{ module.description }}</p>
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-success execute-module" 
                                                                        data-module-id="{{ module_id }}" 
                                                                        data-module-name="{{ module.name }}"
                                                                        {% if not module.enabled %}disabled{% endif %}>
                                                                    <i class="fas fa-play"></i> Execute
                                                                </button>
                                                                <button type="button" class="btn btn-secondary toggle-module" 
                                                                        data-module-id="{{ module_id }}">
                                                                    {% if module.enabled %}
                                                                        <i class="fas fa-toggle-on"></i> Enabled
                                                                    {% else %}
                                                                        <i class="fas fa-toggle-off"></i> Disabled
                                                                    {% endif %}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Execute Module Modal -->
<div class="modal fade" id="executeModuleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Execute BeEF Module</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="executeModuleForm">
                    <div class="form-group">
                        <label>Module Name:</label>
                        <input type="text" class="form-control" id="modalModuleName" readonly>
                    </div>
                    <div class="form-group">
                        <label>Target Browser:</label>
                        <select class="form-control" id="modalTargetBrowser">
                            <option value="all">All Hooked Browsers</option>
                            <option value="latest">Latest Hooked Browser</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Additional Parameters (JSON):</label>
                        <textarea class="form-control" id="modalParameters" rows="3" placeholder='{"param1": "value1", "param2": "value2"}'></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmExecuteBtn">Execute Module</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentModuleId = null;
    
    // Start BeEF Server
    $('#startBeefBtn').click(function() {
        $.post('/api/beef/start', function(data) {
            if (data.success) {
                toastr.success(data.message);
                updateBeefStatus();
            } else {
                toastr.error(data.message);
            }
        }).fail(function() {
            toastr.error('Failed to start BeEF server');
        });
    });
    
    // Stop BeEF Server
    $('#stopBeefBtn').click(function() {
        $.post('/api/beef/stop', function(data) {
            if (data.success) {
                toastr.success(data.message);
                updateBeefStatus();
            } else {
                toastr.error(data.message);
            }
        }).fail(function() {
            toastr.error('Failed to stop BeEF server');
        });
    });
    
    // Refresh Status
    $('#refreshStatusBtn').click(function() {
        updateBeefStatus();
    });
    
    // Execute Module
    $('.execute-module').click(function() {
        currentModuleId = $(this).data('module-id');
        const moduleName = $(this).data('module-name');
        
        $('#modalModuleName').val(moduleName);
        $('#modalParameters').val('{}');
        $('#executeModuleModal').modal('show');
    });
    
    // Confirm Execute
    $('#confirmExecuteBtn').click(function() {
        if (!currentModuleId) return;
        
        const targetBrowser = $('#modalTargetBrowser').val();
        let parameters = {};
        
        try {
            const paramText = $('#modalParameters').val().trim();
            if (paramText) {
                parameters = JSON.parse(paramText);
            }
        } catch (e) {
            toastr.error('Invalid JSON parameters');
            return;
        }
        
        $.post(`/admin/beef/modules/${currentModuleId}/execute`, {
            target_browser: targetBrowser,
            parameters: parameters
        }, function(data) {
            if (data.success) {
                toastr.success(`Module executed: ${data.result.module_name}`);
                $('#executeModuleModal').modal('hide');
            } else {
                toastr.error(data.message);
            }
        }).fail(function() {
            toastr.error('Failed to execute module');
        });
    });
    
    // Toggle Module
    $('.toggle-module').click(function() {
        const moduleId = $(this).data('module-id');
        const button = $(this);
        
        $.post(`/admin/beef/modules/${moduleId}/toggle`, function(data) {
            if (data.success) {
                if (data.enabled) {
                    button.html('<i class="fas fa-toggle-on"></i> Enabled');
                    button.siblings('.execute-module').prop('disabled', false);
                } else {
                    button.html('<i class="fas fa-toggle-off"></i> Disabled');
                    button.siblings('.execute-module').prop('disabled', true);
                }
                toastr.success(data.message);
            } else {
                toastr.error(data.message);
            }
        }).fail(function() {
            toastr.error('Failed to toggle module');
        });
    });
    
    // Update BeEF Status
    function updateBeefStatus() {
        $.get('/api/beef/status', function(data) {
            if (data.success) {
                const status = data.status;
                if (status.running) {
                    $('#beefStatus').html('<span class="badge badge-success">Running</span>');
                } else {
                    $('#beefStatus').html('<span class="badge badge-danger">Stopped</span>');
                }
                // TODO: Update hooked browsers count from actual BeEF server
                $('#hookedBrowsers').text('0');
            }
        }).fail(function() {
            $('#beefStatus').html('<span class="badge badge-warning">Unknown</span>');
        });
    }
    
    // Initial status update
    updateBeefStatus();
    
    // Auto-refresh status every 30 seconds
    setInterval(updateBeefStatus, 30000);
});
</script>
{% endblock %}

